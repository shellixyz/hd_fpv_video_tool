#!/usr/bin/env sh
set -e

MAN_PAGES_DIR="man_pages"

# Refresh index metadata to avoid false positives
git update-index -q --refresh

STASHED=0
cleanup() {
  if [ "$STASHED" -eq 1 ]; then
    git stash pop -q || true
  fi
}
trap cleanup EXIT INT TERM

# Check if there are unstaged OR untracked changes
if ! git diff --no-ext-diff --quiet -- || ! git diff --no-ext-diff --quiet --ignore-submodules --cached -- || \
   [ -n "$(git ls-files --others --exclude-standard)" ]; then
  git stash push -qku -m "pre-commit (keep-index, include-untracked)"
  STASHED=1
fi

printf "\033[1m\033[33mRunning tests\033[0m\n\n"
cargo nextest run

printf "\n\033[1m\033[33mUpdating man pages\033[0m\n\n"
mkdir -p "$MAN_PAGES_DIR"
rm -f "$MAN_PAGES_DIR"/*
cargo run -- generate-man-pages
git add "$MAN_PAGES_DIR"

printf "\n"

